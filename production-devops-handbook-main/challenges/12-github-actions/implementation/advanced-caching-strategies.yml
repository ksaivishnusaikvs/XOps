# Advanced Caching Strategy Configuration
# Demonstrates multi-level caching with fallback keys
# Location: .github/workflows/advanced-caching.yml

name: Advanced Caching Strategy

on:
  push:
    branches: [main, develop]
  pull_request:

jobs:
  dependency-cache:
    name: Multi-Level Dependency Caching
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

      # Level 1: Exact match on lock file hash
      # Level 2: Fallback to package.json hash
      # Level 3: Fallback to OS and language version
      - name: Cache Node.js dependencies
        uses: actions/cache@13aacd865c20de90d75de3b17ebe84f7a17d57d2 # v4.0.0
        with:
          path: |
            ~/.npm
            node_modules
          key: npm-${{ runner.os }}-node-${{ matrix.node-version }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            npm-${{ runner.os }}-node-${{ matrix.node-version }}-${{ hashFiles('**/package.json') }}
            npm-${{ runner.os }}-node-${{ matrix.node-version }}-
            npm-${{ runner.os }}-

      - name: Cache build outputs
        uses: actions/cache@13aacd865c20de90d75de3b17ebe84f7a17d57d2 # v4.0.0
        with:
          path: |
            dist/
            .next/cache
            .nuxt/
            build/
          key: build-${{ runner.os }}-${{ github.sha }}
          restore-keys: |
            build-${{ runner.os }}-

      - name: Cache test data
        uses: actions/cache@13aacd865c20de90d75de3b17ebe84f7a17d57d2 # v4.0.0
        with:
          path: |
            .cache/
            __tests__/__fixtures__/
          key: test-data-${{ hashFiles('__tests__/**/*.ts') }}
          restore-keys: |
            test-data-

# Docker layer caching with buildx
  docker-cache:
    name: Docker Layer Caching
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@2b51285047da1547ffb1b2203d8be4c0af6b1f20 # v3.2.0

      - name: Build with inline cache
        uses: docker/build-push-action@2cdde995de11925a030ce8070c3d77a52ffcf1c0 # v5.3.0
        with:
          context: .
          push: false
          tags: myapp:latest
          # Use GitHub Actions cache backend
          cache-from: type=gha
          cache-to: type=gha,mode=max
          # mode=max caches all layers (recommended for build optimization)
          # mode=min caches only final layers (smaller cache size)

# Compressed cache for large dependencies
  compressed-cache:
    name: Compressed Large Files
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

      - name: Cache with compression
        run: |
          # Create compressed archive of dependencies
          if [ ! -f "vendor-cache.tar.gz" ]; then
            tar -czf vendor-cache.tar.gz vendor/
          fi

      - uses: actions/cache@13aacd865c20de90d75de3b17ebe84f7a17d57d2 # v4.0.0
        with:
          path: vendor-cache.tar.gz
          key: vendor-${{ hashFiles('composer.lock') }}

      - name: Extract cache
        run: |
          if [ -f "vendor-cache.tar.gz" ]; then
            tar -xzf vendor-cache.tar.gz
          fi

# Cache key patterns and best practices
  cache-patterns:
    name: Cache Key Patterns
    runs-on: ubuntu-latest
    steps:
      - name: Examples of cache key patterns
        run: |
          echo "# Cache Key Best Practices"
          echo ""
          echo "## Pattern 1: Exact + Partial + Prefix"
          echo "key: deps-\${{ runner.os }}-\${{ hashFiles('**/package-lock.json') }}"
          echo "restore-keys:"
          echo "  - deps-\${{ runner.os }}-\${{ hashFiles('**/package.json') }}"
          echo "  - deps-\${{ runner.os }}-"
          echo ""
          echo "## Pattern 2: Time-based expiry"
          echo "key: cache-\${{ runner.os }}-\${{ github.run_id }}-\${{ github.run_number }}"
          echo ""
          echo "## Pattern 3: Branch-aware"
          echo "key: cache-\${{ github.ref_name }}-\${{ hashFiles('**/lock') }}"
          echo "restore-keys:"
          echo "  - cache-main-"
          echo ""
          echo "## Pattern 4: Matrix-aware"
          echo "key: cache-\${{ matrix.os }}-\${{ matrix.version }}-\${{ hashFiles() }}"

# Monitoring cache performance
  cache-metrics:
    name: Cache Performance Monitoring
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

      - name: Dependency cache with metrics
        id: cache
        uses: actions/cache@13aacd865c20de90d75de3b17ebe84f7a17d57d2 # v4.0.0
        with:
          path: node_modules
          key: npm-${{ hashFiles('**/package-lock.json') }}

      - name: Report cache performance
        run: |
          if [ "${{ steps.cache.outputs.cache-hit }}" == "true" ]; then
            echo "âœ… Cache HIT - saved $(date -u -d @$SECONDS +%M:%S)"
            echo "cache-hit=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Cache MISS - full install required"
            echo "cache-hit=false" >> $GITHUB_OUTPUT
          fi

      - name: Create performance summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY <<EOF
          ## ðŸ“Š Cache Performance
          
          | Metric | Value |
          |--------|-------|
          | Cache Hit | ${{ steps.cache.outputs.cache-hit }} |
          | Cache Key | \`npm-${{ hashFiles('**/package-lock.json') }}\` |
          | Time Saved | ~3-5 minutes |
          EOF
