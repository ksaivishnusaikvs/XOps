# ArgoCD Image Updater - Automatic Image Updates

# Annotation-based configuration for automatic image updates
# Add to Application manifest:
#
# annotations:
#   argocd-image-updater.argoproj.io/image-list: myapp=ghcr.io/org/myapp
#   argocd-image-updater.argoproj.io/myapp.update-strategy: latest
#   argocd-image-updater.argoproj.io/myapp.allow-tags: regexp:^v[0-9]+\.[0-9]+\.[0-9]+$
#   argocd-image-updater.argoproj.io/write-back-method: git

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-image-updater-config
  namespace: argocd
data:
  applications_api: argocd
  argocd.insecure: "false"
  argocd.plaintext: "false"
  argocd.server_addr: argocd-server.argocd
  
  git.commit-message-template: |
    build: automatic update of {{.AppName}}
    
    {{range .AppChanges -}}
    - {{.Image}}:{{.OldTag}} -> {{.NewTag}}
    {{end}}
  
  git.user: argocd-image-updater
  git.email: argocd@example.com

---
# Example Application with Image Updater
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: dev-myapp
  namespace: argocd
  annotations:
    # Image list to track
    argocd-image-updater.argoproj.io/image-list: app=ghcr.io/org/myapp
    
    # Update strategy: latest, semver, digest
    argocd-image-updater.argoproj.io/app.update-strategy: semver
    
    # Allow only semantic version tags
    argocd-image-updater.argoproj.io/app.allow-tags: regexp:^v[0-9]+\.[0-9]+\.[0-9]+$
    
    # Ignore specific tags
    argocd-image-updater.argoproj.io/app.ignore-tags: latest,dev,pr-*
    
    # Pull secrets
    argocd-image-updater.argoproj.io/app.pull-secret: pullsecret:argocd/github-pull-secret
    
    # Write back to Git
    argocd-image-updater.argoproj.io/write-back-method: git:secret:argocd/git-creds
    argocd-image-updater.argoproj.io/git-branch: main
    
    # Update frequency
    argocd-image-updater.argoproj.io/update-strategy: latest
spec:
  project: default
  source:
    repoURL: https://github.com/org/gitops-config
    path: apps/myapp/dev
    targetRevision: main
  destination:
    server: https://kubernetes.default.svc
    namespace: dev
  syncPolicy:
    automated:
      prune: true
      selfHeal: true

---
# Deployment for Image Updater
apiVersion: apps/v1
kind: Deployment
metadata:
  name: argocd-image-updater
  namespace: argocd
spec:
  replicas: 1
  selector:
    matchLabels:
      app: argocd-image-updater
  template:
    metadata:
      labels:
        app: argocd-image-updater
    spec:
      serviceAccountName: argocd-image-updater
      containers:
      - name: argocd-image-updater
        image: quay.io/argoprojlabs/argocd-image-updater:v0.12.0
        args:
          - run
          - --interval
          - "2m"
          - --health-port
          - "8080"
          - --loglevel
          - info
        env:
          - name: ARGOCD_TOKEN
            valueFrom:
              secretKeyRef:
                name: argocd-image-updater-secret
                key: argocd.token
        ports:
          - containerPort: 8080
        livenessProbe:
          httpGet:
            path: /healthz
            port: 8080
          initialDelaySeconds: 3
          periodSeconds: 30
        readinessProbe:
          httpGet:
            path: /healthz
            port: 8080
          initialDelaySeconds: 3
          periodSeconds: 30
